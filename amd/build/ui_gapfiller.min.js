define(["jquery"],function(a){function b(b,c,d,e){var f;this.textArea=a(document.getElementById(b)),this.readOnly=this.textArea.prop("readonly"),this.templateParams=e,this.fail=!1,this.htmlDiv=null,this.source=e.gapfiller_ui_source||"globalextra","globalextra"!==this.source&&"test0"!==this.source&&(alert("Invalid source for HTML in ui_gapfiller"),this.source="globalextra"),f="globalextra"==this.source?this.textArea.attr("data-globalextra"):this.textArea.attr("data-test0"),this.html=f.replace("<","&lt;"),this.reload()}return b.prototype.failed=function(){return this.fail},b.prototype.sync=function(){var b=[],c=!0;this.getFields().each(function(){var d,e;d=a(this).attr("name"),"cr_gapfiller_field"!==d?alert("Unexpected UI element found in answer box"):(e=a(this).val(),b.push(e),""!==e&&(c=!1))}),c?this.textArea.val(""):this.textArea.val(JSON.stringify(b))},b.prototype.getElement=function(){return this.htmlDiv},b.prototype.getFields=function(){return a(this.htmlDiv).find(".coderunner-ui-element")},b.prototype.setField=function(a,b){"checkbox"===a.attr("type")||"radio"===a.attr("type")?a.prop("checked",a.val()===b):a.val(b)},b.prototype.markedUpHtml=function(){function a(a){for(var b,c="{[(*+\\",d="",e=0;e<a.length;e++){b=a[e];for(var f=0;f<c.length;f++)b===c[f]&&(b="\\"+b);d+=b}return d}var b,c=a("{["),d=a("]}"),e=new RegExp(c+" *((?:\\d+)|(?:\\d+, *\\d+)) *"+d),f=this.html.split(e),g="<pre>"+f[0];for(b=1;b<f.length;b+=2)g+=this.markUp(f[b]),b+1<f.length&&(g+=f[b+1]);return g+="</pre>"},b.prototype.markUp=function(a){function b(a){return'<input name="cr_gapfiller_field" class="coderunner-ui-element" size="'+a+'">'}function c(a,b){return'<textarea name="cr_gapfiller_field" class ="coderunner-ui-element" rows="'+a+'" cols="'+b+'" style="width:auto;" />'}var d,e="";return d=a.split(","),e=1==d.length?b(parseInt(d[0])):c(parseInt(d[0]),parseInt(d[1]))},b.prototype.reload=function(){var b,c,d,e=a(this.textArea).val(),f="<div style='height:fit-content' class='qtype-coderunner-html-outer-div'>";if(this.htmlDiv=a(f+this.markedUpHtml()+"</div>"),e)try{if(b=JSON.parse(e),d=this.getFields(),d.length!==b.length)this.fail=!0;else for(c=0;c<b.length;c++)this.setField(a(d[c]),b[c])}catch(g){}},b.prototype.resize=function(){},b.prototype.hasFocus=function(){var a=!1;return this.getFields().each(function(){this===document.activeElement&&(a=!0)}),a},b.prototype.destroy=function(){this.sync(),a(this.htmlDiv).remove(),this.htmlDiv=null},{Constructor:b}});