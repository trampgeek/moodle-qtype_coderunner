define(["jquery"],function(a){function b(b,c,d,e){var f,g=a(document.getElementById(b)),h=g[0]===document.activeElement,i=e.lang;this.MIN_WIDTH=300,this.MIN_HEIGHT=100;try{window.ace.require("ace/ext/language_tools"),this.modelist=window.ace.require("ace/ext/modelist"),this.textarea=g,this.enabled=!1,this.contents_changed=!1,this.capturingTab=!1,this.clickInProgress=!1,this.editNode=a("<div></div>"),this.editNode.css({resize:"none",height:d,width:"100%"}),this.editor=window.ace.edit(this.editNode.get(0)),g.prop("readonly")&&this.editor.setReadOnly(!0),this.editor.setOptions({enableBasicAutocompletion:!0,newLineMode:"unix"}),this.editor.$blockScrolling=1/0,f=this.editor.getSession(),f.setValue(this.textarea.val()),this.setLanguage(i),this.setEventHandlers(g),this.captureTab(),a(".ace_gutter").addClass("moodle-has-zindex"),g.hide(),h&&(this.editor.focus(),this.editor.navigateFileEnd()),this.aceLabel=a(".answerprompt"),this.aceLabel.attr("for","ace_"+b),this.aceTextarea=a(".ace_text-input"),this.aceTextarea.attr("id","ace_"+b),this.fail=!1}catch(j){this.fail=!0}}return b.prototype.failed=function(){return this.fail},b.prototype.setLanguage=function(a){var b=this.editor.getSession(),c=this.findMode(a);c&&b.setMode(c.mode)},b.prototype.getMinSize=function(){return{minWidth:this.MIN_WIDTH,minHeight:this.MIN_HEIGHT}},b.prototype.getElement=function(){return this.editNode},b.prototype.captureTab=function(){this.capturingTab=!0,this.editor.commands.bindKeys({Tab:"indent","Shift-Tab":"outdent"})},b.prototype.releaseTab=function(){this.capturingTab=!1,this.editor.commands.bindKeys({Tab:null,"Shift-Tab":null})},b.prototype.setEventHandlers=function(){var a=9,b=27,c=77,d=this;this.editor.getSession().on("change",function(){d.textarea.val(d.editor.getSession().getValue()),d.contents_changed=!0}),this.editor.on("blur",function(){d.contents_changed&&d.textarea.trigger("change")}),this.editor.on("mousedown",function(){d.clickInProgress=!0}),this.editor.on("focus",function(){d.clickInProgress?d.captureTab():d.releaseTab()}),this.editor.on("click",function(){d.clickInProgress=!1}),this.editor.container.addEventListener("keydown",function(e){void 0!==e.which&&0===e.which||(e.keyCode===c&&e.ctrlKey&&!e.altKey?(d.capturingTab?d.releaseTab():d.captureTab(),e.preventDefault()):e.keyCode===b?d.releaseTab():e.shiftKey||e.ctrlKey||e.altKey||e.keyCode==a||d.captureTab())},!0)},b.prototype.destroy=function(){var b;this.fail||(b=this.editor.isFocused(),this.textarea.val(this.editor.getSession().getValue()),this.editor.destroy(),a(this.editNode).remove(),b&&(this.textarea.focus(),this.textarea[0].selectionStart=this.textarea[0].value.length))},b.prototype.hasFocus=function(){return this.editor.isFocused()},b.prototype.findMode=function(a){var b,c,d,e=[],f={octave:"matlab",nodejs:"javascript","c#":"cs"};if("string"==typeof a){a.toLowerCase()in f&&(a=f[a.toLowerCase()]),e=[a,a.replace(/\d+$/,"")];for(var g=0;g<e.length;g++)if(b=e[g],c="input."+b,d=this.modelist.modesByName[b]||this.modelist.modesByName[b.toLowerCase()]||this.modelist.getModeForPath(c)||this.modelist.getModeForPath(c.toLowerCase()),d&&"text"!==d.name)return d}},b.prototype.resize=function(a,b){this.editNode.outerHeight(b),this.editNode.outerWidth(a),this.editor.resize()},{Constructor:b}});