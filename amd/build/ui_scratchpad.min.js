define("qtype_coderunner/ui_scratchpad",["exports","core/ajax","core/templates","qtype_coderunner/userinterfacewrapper","qtype_coderunner/outputdisplayarea"],(function(_exports,_ajax,_templates,_userinterfacewrapper,_outputdisplayarea){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.Constructor=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates);var invertSerial=function(current){return"1"==current[0]?[""]:["1"]},overwriteValues=function(defaults,prescribed){var overwritten=function(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}({},defaults);if(prescribed)for(var _i=0,_Object$entries=Object.entries(defaults);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),key=_Object$entries$_i[0],value=_Object$entries$_i[1];overwritten[key]=prescribed[key]||value}return overwritten},ScratchpadUi=function(){function ScratchpadUi(textAreaId,width,height,uiParams){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ScratchpadUi);var DEF_UI_PARAMS={scratchpad_name:"",button_name:"",prefix_name:"",help_text:"",run_lang:uiParams.lang,html_output:!1,disable_scratchpad:!1,wrapper_src:null};this.textArea=document.getElementById(textAreaId),this.textAreaId=textAreaId,this.height=height,this.readOnly=this.textArea.readonly,this.fail=!1,this.outerDiv=null,this.outputDisplay=null,this.invertPreload=uiParams.invert_prefix,this.lang=uiParams.lang,this.numRows=this.textArea.rows,this.uiParams=overwriteValues(DEF_UI_PARAMS,uiParams),this.runWrapper=this.getRunWrapper(),this.reload()}var Constructor,protoProps,staticProps,fn,_reload;return Constructor=ScratchpadUi,protoProps=[{key:"getRunWrapper",value:function(){var wrapperSrc=this.uiParams.wrapper_src,runWrapper=null;return wrapperSrc&&("globalextra"===wrapperSrc||"prototypeextra"===wrapperSrc?runWrapper=this.textArea.dataset[wrapperSrc]:(this.fail=!0,this.failString="scratchpad_ui_badrunwrappersrc")),runWrapper}},{key:"failed",value:function(){return this.fail}},{key:"failMessage",value:function(){return this.failString}},{key:"sync",value:function(){if(this.context){var serialisation=this.getSerialisation();this.setSerialisation(serialisation)}}},{key:"getSerialisation",value:function(){var prefixAns=document.getElementById(this.context.prefix_ans.id),showHide=document.getElementById(this.context.show_hide.id),serialisation={answer_code:[""],test_code:[""],show_hide:[""],prefix_ans:[""]};return this.answerTextarea&&(serialisation.answer_code=[this.answerTextarea.value]),this.testTextarea&&(serialisation.test_code=[this.testTextarea.value]),showHide&&!function(el){if(!el.classList.contains("collapse"))throw Error("Element does not have collapse class");return!el.classList.contains("show")}(showHide)&&(serialisation.show_hide=["1"]),(null!=prefixAns&&prefixAns.checked||this.context.disable_scratchpad)&&(serialisation.prefix_ans=["1"]),this.invertPreload&&(serialisation.prefix_ans=invertSerial(serialisation.prefix_ans)),serialisation}},{key:"setSerialisation",value:function(serialisation){serialisation.prefix_ans=invertSerial(serialisation.prefix_ans),Object.values(serialisation).some((function(val){return 1===val.length&&val[0].length>0}))?(serialisation.prefix_ans=invertSerial(serialisation.prefix_ans),this.textArea.value=JSON.stringify(serialisation)):this.textArea.value=""}},{key:"getElement",value:function(){return this.outerDiv}},{key:"handleRunButtonClick",value:function(){this.sync();var answerCode,testCode,prefixAns,template,preloadString=this.textArea.value,serial=this.readJson(preloadString),sandboxParams=this.uiParams.params,language=this.lang,code=(answerCode=serial.answer_code,testCode=serial.test_code,prefixAns=serial.prefix_ans[0],(template=this.runWrapper)||(template="{{ ANSWER_CODE }}\n{{ SCRATCHPAD_CODE }}"),prefixAns||(answerCode=""),(template=template.replaceAll("{{ ANSWER_CODE }}",answerCode)).replaceAll("{{ SCRATCHPAD_CODE }}",testCode));this.outputDisplay.handleRunButtonClick(code,language,sandboxParams)}},{key:"updateContext",value:function(preload){this.context={id:this.textAreaId,disable_scratchpad:this.uiParams.disable_scratchpad,scratchpad_name:this.uiParams.scratchpad_name,button_name:this.uiParams.button_name,help_text:{text:this.uiParams.help_text},answer_code:{id:this.textAreaId+"_answer-code",name:"answer_code",text:preload.answer_code[0],lang:this.lang,rows:this.numRows},test_code:{id:this.textAreaId+"_test-code",name:"test_code",text:preload.test_code[0],lang:this.lang,rows:6},show_hide:{id:this.textAreaId+"_scratchpad",show:preload.show_hide[0]},prefix_ans:{id:this.textAreaId+"_prefix-ans",label:this.uiParams.prefix_name,checked:preload.prefix_ans[0]},output_display:{id:this.textAreaId+"_run-output"},jquery_escape:function(){return function(text,render){return CSS.escape(render(text))}}}}},{key:"readJson",value:function(preloadString){var serial;if(""!==preloadString){try{serial=JSON.parse(preloadString)}catch(_unused){serial={answer_code:[preloadString]}}if(!serial.hasOwnProperty("answer_code"))throw TypeError("JSON has wrong signature, missing answer_code field.")}return serial=overwriteValues({answer_code:[""],test_code:[""],show_hide:[""],prefix_ans:["1"]},serial),this.invertPreload&&(serial.prefix_ans=invertSerial(serial.prefix_ans)),serial}},{key:"reload",value:(fn=regeneratorRuntime.mark((function _callee(){var preloadString,preload,_yield$Templates$rend,html,outputMode;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:preloadString=this.textArea.value,_context.prev=1,preload=this.readJson(preloadString),_context.next=10;break;case 5:return _context.prev=5,_context.t0=_context.catch(1),this.fail=!0,this.failString="scratchpad_ui_invalidserialisation",_context.abrupt("return");case 10:return this.updateContext(preload),_context.prev=11,_context.next=14,_templates.default.renderForPromise("qtype_coderunner/scratchpad_ui",this.context);case 14:_yield$Templates$rend=_context.sent,html=_yield$Templates$rend.html,outputMode=this.uiParams.html_output?"html":"text",this.drawUi(html),this.addAceUis(),this.outputDisplay=new _outputdisplayarea.OutputDisplayArea(this.context.output_display.id,outputMode),this.addEventListeners(),_context.next=28;break;case 23:return _context.prev=23,_context.t1=_context.catch(11),this.fail=!0,this.failString="scratchpad_ui_templateloadfail",_context.abrupt("return");case 28:case"end":return _context.stop()}}),_callee,this,[[1,5],[11,23]])})),_reload=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(){return _reload.apply(this,arguments)})},{key:"drawUi",value:function(html){var wrapperDiv=document.getElementById(this.textAreaId).nextSibling;wrapperDiv.innerHTML=html,this.outerDiv=wrapperDiv.firstChild,wrapperDiv.style.resize="none"}},{key:"addAceUis",value:function(){this.answerTextarea=document.getElementById(this.context.answer_code.id),this.testTextarea=document.getElementById(this.context.test_code.id),this.answerCodeUi=(0,_userinterfacewrapper.newUiWrapper)("ace",this.context.answer_code.id),this.testTextarea&&(this.testCodeUi=(0,_userinterfacewrapper.newUiWrapper)("ace",this.context.test_code.id))}},{key:"addEventListeners",value:function(){var _this=this,runButton=document.getElementById(this.textAreaId+"_run-btn"),outputDisplayarea=document.getElementById(this.context.output_display.id);runButton&&runButton.addEventListener("click",(function(){return _this.handleRunButtonClick(_ajax.default,outputDisplayarea)}))}},{key:"resize",value:function(){}},{key:"hasFocus",value:function(){var _this$answerCodeUi,_this$testCodeUi,focused=!1;return null!==(_this$answerCodeUi=this.answerCodeUi)&&void 0!==_this$answerCodeUi&&_this$answerCodeUi.uiInstance.hasFocus()&&(focused=!0),null!==(_this$testCodeUi=this.testCodeUi)&&void 0!==_this$testCodeUi&&_this$testCodeUi.uiInstance.hasFocus()&&(focused=!0),focused}},{key:"destroy",value:function(){var _this$answerCodeUi2,_this$testCodeUiCodeU,_this$outerDiv;this.sync(),null===(_this$answerCodeUi2=this.answerCodeUi)||void 0===_this$answerCodeUi2||_this$answerCodeUi2.uiInstance.destroy(),null===(_this$testCodeUiCodeU=this.testCodeUiCodeUi)||void 0===_this$testCodeUiCodeU||_this$testCodeUiCodeU.uiInstance.destroy(),null===(_this$outerDiv=this.outerDiv)||void 0===_this$outerDiv||_this$outerDiv.remove(),this.outerDiv=null}}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),ScratchpadUi}();_exports.Constructor=ScratchpadUi}));

//# sourceMappingURL=ui_scratchpad.min.js.map