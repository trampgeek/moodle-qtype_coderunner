define(["jquery","qtype_coderunner/graphutil","qtype_coderunner/graphelements"],function(a,b,c){function d(b,c,d,e){this.HANDLE_SIZE=10,this.parent=b,this.canvas=a(document.createElement("canvas")),this.canvas.attr({id:c,"class":"coderunner_graphcanvas",tabindex:1}),this.canvas.css({"background-color":"white"}),this.canvas.on("mousedown",function(a){return b.mousedown(a)}),this.canvas.on("mouseup",function(a){return b.mouseup(a)}),this.canvas.on("dblclick",function(a){return b.dblclick(a)}),this.canvas.on("keydown",function(a){return b.keydown(a)}),this.canvas.on("mousemove",function(a){return b.mousemove(a)}),this.canvas.on("keypress",function(a){return b.keypress(a)}),this.resize=function(a,b){this.canvas.attr("width",a),this.canvas.attr("height",b)},this.resize(d,e)}function e(b,e,f,g){var h=this;this.SNAP_TO_PADDING=6,this.DUPLICATE_LINK_OFFSET=16,this.HIT_TARGET_PADDING=6,this.DEFAULT_NODE_RADIUS=26,this.DEFAULT_FONT_SIZE=20,this.canvasId="graphcanvas_"+b,this.textArea=a(document.getElementById(b)),this.helpText="",this.readOnly=this.textArea.prop("readonly"),this.templateParams=g,this.graphCanvas=new d(this,this.canvasId,e,f),this.caretVisible=!0,this.caretTimer=0,this.originalClick=null,this.nodes=[],this.links=[],this.helpBox=new c.HelpBox(this,0,0),this.helpBoxHighlighted=!1,this.selectedObject=null,this.currentLink=null,this.movingObject=!1,this.fail=!1,this.failString=null,require(["core/str"],function(b){var c=b.get_string("graphhelp","qtype_coderunner");a.when(c).done(function(a){h.helpText=a})}),this.reload(),this.fail||this.draw()}return e.prototype.failed=function(){return this.fail},e.prototype.failMessage=function(){return this.failString},e.prototype.getElement=function(){return this.getCanvas()},e.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()},e.prototype.getCanvas=function(){var a=this.graphCanvas.canvas[0];return a},e.prototype.nodeRadius=function(){return this.templateParams.noderadius?this.templateParams.noderadius:this.DEFAULT_NODE_RADIUS},e.prototype.fontSize=function(){return this.templateParams.fontsize?this.templateParams.fontsize:this.DEFAULT_FONT_SIZE},e.prototype.isFsm=function(){return void 0===this.templateParams.isfsm||this.templateParams.isfsm},e.prototype.arrowIfReqd=function(a,c,d,e){(void 0===this.templateParams.isdirected||this.templateParams.isdirected)&&b.drawArrow(a,c,d,e)},e.prototype.sync=function(){},e.prototype.keypress=function(a){var c=b.crossBrowserKey(a);if(!this.readOnly)return c>=32&&c<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==this.selectedObject&&"text"in this.selectedObject?(this.selectedObject.text+=String.fromCharCode(c),this.resetCaret(),this.draw(),!1):8!==c&&32!==c&&9!==c&&void 0},e.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);if(!this.readOnly)return this.selectedObject=this.selectObject(d.x,d.y),this.movingObject=!1,this.originalClick=d,null!==this.selectedObject?(a.shiftKey&&this.selectedObject instanceof c.Node?this.currentLink=new c.SelfLink(this,this.selectedObject,d):(this.movingObject=!0,this.selectedObject.setMouseStart&&this.selectedObject.setMouseStart(d.x,d.y)),this.resetCaret()):a.shiftKey&&this.isFsm()&&(this.currentLink=new c.TemporaryLink(this,d,d)),this.draw(),!this.hasFocus()&&(this.resetCaret(),!0)},e.prototype.keydown=function(a){var c=b.crossBrowserKey(a);if(!this.readOnly){if(8===c)return null!==this.selectedObject&&"text"in this.selectedObject&&(this.selectedObject.text=this.selectedObject.text.substr(0,this.selectedObject.text.length-1),this.resetCaret(),this.draw()),!1;if(46===c){if(null!==this.selectedObject){for(var d=0;d<this.nodes.length;d++)this.nodes[d]===this.selectedObject&&this.nodes.splice(d--,1);for(var d=0;d<this.links.length;d++)this.links[d]!==this.selectedObject&&this.links[d].node!==this.selectedObject&&this.links[d].nodeA!==this.selectedObject&&this.links[d].nodeB!==this.selectedObject||this.links.splice(d--,1);this.selectedObject=null,this.draw()}}else 13===c&&null!==this.selectedObject&&(this.selectedObject=null,this.draw())}},e.prototype.dblclick=function(a){var d=b.crossBrowserRelativeMousePos(a);this.readOnly||(this.selectedObject=this.selectObject(d.x,d.y),null===this.selectedObject?(this.selectedObject=new c.Node(this,d.x,d.y),this.nodes.push(this.selectedObject),this.resetCaret(),this.draw()):this.selectedObject instanceof c.Node&&(this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState,this.draw()))},e.prototype.resize=function(a,b){this.graphCanvas.resize(a,b),this.draw()},e.prototype.mousemove=function(a){var d,e=b.crossBrowserRelativeMousePos(a),f=this.helpBox.containsPoint(e.x,e.y);if(!this.readOnly){if(f!=this.helpBoxHighlighted&&(this.helpBoxHighlighted=f,this.draw()),null!==this.currentLink){var g=this.selectObject(e.x,e.y);g instanceof c.Node||(g=null),null===this.selectedObject?null!==g?this.currentLink=new c.StartLink(this,g,this.originalClick):this.currentLink=new c.TemporaryLink(this,this.originalClick,e):g===this.selectedObject?this.currentLink=new c.SelfLink(this,this.selectedObject,e):null!==g?this.currentLink=new c.Link(this,this.selectedObject,g):(d=this.selectedObject.closestPointOnCircle(e.x,e.y),this.currentLink=new c.TemporaryLink(this,d,e)),this.draw()}this.movingObject&&(this.selectedObject.setAnchorPoint(e.x,e.y),this.selectedObject instanceof c.Node&&this.snapNode(this.selectedObject),this.draw())}},e.prototype.mouseup=function(){this.readOnly||(this.movingObject=!1,null!==this.currentLink&&(this.currentLink instanceof c.TemporaryLink||(this.selectedObject=this.currentLink,this.addLink(this.currentLink),this.resetCaret()),this.currentLink=null,this.draw()))},e.prototype.selectObject=function(a,b){if(this.helpBox.containsPoint(a,b)&&this.selectedObject!=this.helpBox)return this.helpBox;for(var c=0;c<this.nodes.length;c++)if(this.nodes[c].containsPoint(a,b))return this.nodes[c];for(var c=0;c<this.links.length;c++)if(this.links[c].containsPoint(a,b))return this.links[c];return null},e.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++)this.nodes[b]!==a&&(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING&&(a.x=this.nodes[b].x),Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING&&(a.y=this.nodes[b].y))},e.prototype.addLink=function(a){for(var b=null,c=0;c<this.links.length;c++){var d=this.links[c];d.nodeA===a.nodeA&&d.nodeB===a.nodeB&&(null===b||d.perpendicularPart>b)&&(b=d.perpendicularPart),d.nodeA===a.nodeB&&d.nodeB===a.nodeA&&(null===b||-d.perpendicularPart>b)&&(b=-d.perpendicularPart)}null!==b&&(a.perpendicularPart=b+this.DUPLICATE_LINK_OFFSET),this.links.push(a)},e.prototype.reload=function(){var b=a(this.textArea).val();if(b)try{for(var d=JSON.parse(b),e=0;e<d.nodes.length;e++){var f=d.nodes[e],g=d.nodeGeometry[e],h=new c.Node(this,g[0],g[1]);h.isAcceptState=f[1],h.text=f[0].toString(),this.nodes.push(h)}for(var e=0;e<d.edges.length;e++){var i=d.edges[e],j=d.edgeGeometry[e],k=null;i[0]===i[1]?(k=new c.SelfLink(this,this.nodes[i[0]]),k.anchorAngle=j.anchorAngle,k.text=i[2].toString()):i[0]===-1?(k=new c.StartLink(this,this.nodes[i[1]]),k.deltaX=j.deltaX,k.deltaY=j.deltaY):(k=new c.Link(this,this.nodes[i[0]],this.nodes[i[1]]),k.parallelPart=j.parallelPart,k.perpendicularPart=j.perpendicularPart,k.text=i[2].toString(),k.lineAngleAdjust=j.lineAngleAdjust),null!==k&&this.links.push(k)}}catch(l){this.fail=!0,this.failString="graph_ui_invalidserialisation"}},e.prototype.save=function(){var a={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]};if(JSON&&(""!==this.textArea.val().trim()||0!==this.nodes.length)){for(var b=0;b<this.nodes.length;b++){var d=this.nodes[b],e=[d.text,d.isAcceptState],f=[d.x,d.y];a.nodeGeometry.push(f),a.nodes.push(e)}for(var b=0;b<this.links.length;b++){var g=this.links[b],h=null,i=null;g instanceof c.SelfLink?(i={anchorAngle:g.anchorAngle},h=[this.nodes.indexOf(g.node),this.nodes.indexOf(g.node),g.text]):g instanceof c.StartLink?(i={deltaX:g.deltaX,deltaY:g.deltaY},h=[-1,this.nodes.indexOf(g.node),""]):g instanceof c.Link&&(i={lineAngleAdjust:g.lineAngleAdjust,parallelPart:g.parallelPart,perpendicularPart:g.perpendicularPart},h=[this.nodes.indexOf(g.nodeA),this.nodes.indexOf(g.nodeB),g.text]),null!==h&&null!==i&&(a.edges.push(h),a.edgeGeometry.push(i))}this.textArea.val(JSON.stringify(a))}},e.prototype.destroy=function(){clearInterval(this.caretTimer),this.graphCanvas.canvas.off(),this.graphCanvas.canvas.remove()},e.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer),this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible,a.draw()},500),this.caretVisible=!0},e.prototype.draw=function(){var a=this.getCanvas(),b=a.getContext("2d");if(b.clearRect(0,0,this.getCanvas().width,this.getCanvas().height),b.save(),b.translate(.5,.5),this.helpBox.draw(b,this.selectedObject==this.helpBox,this.helpBoxHighlighted),this.selectedObject!=this.helpBox){for(var c=0;c<this.nodes.length;c++)b.lineWidth=1,b.fillStyle=b.strokeStyle=this.nodes[c]===this.selectedObject?"blue":"black",this.nodes[c].draw(b);for(var c=0;c<this.links.length;c++)b.lineWidth=1,b.fillStyle=b.strokeStyle=this.links[c]===this.selectedObject?"blue":"black",this.links[c].draw(b);null!==this.currentLink&&(b.lineWidth=1,b.fillStyle=b.strokeStyle="black",this.currentLink.draw(b))}b.restore(),this.save()},e.prototype.drawText=function(a,c,d,e,f){var g,h,i=this.getCanvas().getContext("2d"),j=b.convertLatexShortcuts(a);if(i.font=this.fontSize()+"px Arial",g=i.measureText(j).width,c-=g/2,null!==e){var k=Math.cos(e),l=Math.sin(e),m=(g/2+5)*(k>0?1:-1),n=15*(l>0?1:-1),o=l*Math.pow(Math.abs(l),40)*m-k*Math.pow(Math.abs(k),10)*n;c+=m-l*o,d+=n+k*o}"advancedFillText"in i?i.advancedFillText(j,a,c+g/2,d,e):(c=Math.round(c),d=Math.round(d),h=Math.round(this.fontSize()/3),i.fillText(j,c,d+h),f==this.selectedObject&&this.caretVisible&&this.hasFocus()&&document.hasFocus()&&(c+=g,h=Math.round(this.fontSize()/2),i.beginPath(),i.moveTo(c,d-h),i.lineTo(c,d+h),i.stroke()))},{Constructor:e}});